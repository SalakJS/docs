<!DOCTYPE html><html lang="zh-cn"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Controller · Salak</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="控制器，用于处理用户的请求，然后返回相应的结果。"/><meta name="docsearch:language" content="zh-cn"/><meta property="og:title" content="Controller · Salak"/><meta property="og:type" content="website"/><meta property="og:url" content="https://salakjs.github.io/docs/index.html"/><meta property="og:description" content="控制器，用于处理用户的请求，然后返回相应的结果。"/><meta property="og:image" content="https://salakjs.github.io/docs/img/salak.png"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://salakjs.github.io/docs/img/salak.png"/><link rel="shortcut icon" href="/docs/img/favicon.png"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><link rel="stylesheet" href="/docs/css/main.css"/></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/docs/zh-cn"><img class="logo" src="/docs/img/salak.png" alt="Salak"/><h2 class="headerTitleWithLogo">Salak</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class="siteNavGroupActive"><a href="/docs/docs/zh-cn/introduction.html" target="_self">文档</a></li><span><li><a id="languages-menu" href="#"><img class="languages-icon" src="/docs/img/language.svg"/>中文</a><div id="languages-dropdown" class="hide"><ul id="languages-dropdown-items"><li><a href="/docs/docs/en/controller.html">English</a></li></ul></div></li><script>
        const languagesMenuItem = document.getElementById("languages-menu");
        const languagesDropDown = document.getElementById("languages-dropdown");
        languagesMenuItem.addEventListener("click", function(event) {
          event.preventDefault();

          if (languagesDropDown.className == "hide") {
            languagesDropDown.className = "visible";
          } else {
            languagesDropDown.className = "hide";
          }
        });
      </script></span><li class=""><a href="https://github.com/salakjs/salak" target="_self">GitHub</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="container docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><i></i></div><h2><i>›</i><span>基础功能</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">新手入门</h3><ul><li class="navListItem"><a class="navItem" href="/docs/docs/zh-cn/introduction.html">简介</a></li><li class="navListItem"><a class="navItem" href="/docs/docs/zh-cn/quick.html">快速入门</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">基础功能</h3><ul><li class="navListItem"><a class="navItem" href="/docs/docs/zh-cn/structure.html">目录结构</a></li><li class="navListItem"><a class="navItem" href="/docs/docs/zh-cn/objects.html">内置对象</a></li><li class="navListItem"><a class="navItem" href="/docs/docs/zh-cn/config.html">配置</a></li><li class="navListItem"><a class="navItem" href="/docs/docs/zh-cn/middleware.html">中间件</a></li><li class="navListItem"><a class="navItem" href="/docs/docs/zh-cn/router.html">路由</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/docs/docs/zh-cn/controller.html">Controller</a></li><li class="navListItem"><a class="navItem" href="/docs/docs/zh-cn/behavior.html">Behavior</a></li><li class="navListItem"><a class="navItem" href="/docs/docs/zh-cn/service.html">Service</a></li><li class="navListItem"><a class="navItem" href="/docs/docs/zh-cn/schedule.html">定时任务</a></li><li class="navListItem"><a class="navItem" href="/docs/docs/zh-cn/extend.html">扩展</a></li><li class="navListItem"><a class="navItem" href="/docs/docs/zh-cn/plugin.html">插件</a></li><li class="navListItem"><a class="navItem" href="/docs/docs/zh-cn/logger.html">日志</a></li><li class="navListItem"><a class="navItem" href="/docs/docs/zh-cn/doc.html">接口文档</a></li><li class="navListItem"><a class="navItem" href="/docs/docs/zh-cn/init.html">启动自定义</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">进阶介绍</h3><ul><li class="navListItem"><a class="navItem" href="/docs/docs/zh-cn/view.html">视图</a></li><li class="navListItem"><a class="navItem" href="/docs/docs/zh-cn/database.html">数据库</a></li><li class="navListItem"><a class="navItem" href="/docs/docs/zh-cn/i18n.html">国际化</a></li><li class="navListItem"><a class="navItem" href="/docs/docs/zh-cn/curl.html">CURL</a></li><li class="navListItem"><a class="navItem" href="/docs/docs/zh-cn/loader.html">Loader</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle">扩展功能</h3><ul><li class="navListItem"><a class="navItem" href="/docs/docs/zh-cn/multi-module.html">多模块项目</a></li><li class="navListItem"><a class="navItem" href="/docs/docs/zh-cn/typescript.html">Typescript</a></li></ul></div></div></section></div><script>
            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              const headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                if (event.target.tagName === 'A') {
                  document.body.classList.remove('tocActive');
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 class="postHeaderTitle">Controller</h1></header><article><div><span><p>控制器，用于处理用户的请求，然后返回相应的结果。</p>
<p>控制器会自动校验数据，根据规则自动注册路由。</p>
<h2><a class="anchor" aria-hidden="true" id="controller编写"></a><a href="#controller编写" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Controller编写</h2>
<p>所有的Controller文件必须存放在功能模块的controller目录下，支持多级目录，访问的时候通过相应的目录层级来访问。</p>
<p>框架默认提供了Controller基类，通过定义Controller类来编写代码：</p>
<pre><code class="hljs css languages- javascript"><span class="hljs-comment">// user/controller/user.js</span>
<span class="hljs-keyword">const</span> { Controller } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'salak'</span>)

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Controller</span> </span>{
  <span class="hljs-keyword">async</span> actionIndex () {
    <span class="hljs-comment">// do something</span>
  }

  <span class="hljs-keyword">async</span> actionLogin () {
    <span class="hljs-comment">// doLogin</span>
  }
}

<span class="hljs-built_in">module</span>.exports = User
</code></pre>
<p>我们定义了User类，类中actionXxx会自动注册到路由上，默认会注册：</p>
<pre><code class="hljs css languages- bash">actionIndex =&gt; GET /user
actionLogin =&gt; GET /user/login
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="action定义"></a><a href="#action定义" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>action定义</h3>
<p>格式为：actionXxx，xxx为默认注册到路由上的地址，xxx为驼峰式</p>
<p>比如：</p>
<p>/frontend/controller/blog/post.js 中的actionIndex，默认注册到的路由为/frontend/blog/post</p>
<p>/frontend/controller/blog/post.js 中的actionShow，默认注册到的路由为/frontend/blog/post/show</p>
<p>action参数，会自动将ctx.params绑定上。</p>
<p>如：</p>
<pre><code class="hljs css languages- javascript"><span class="hljs-keyword">async</span> actionIndex (id, user) { <span class="hljs-comment">// 会注册成 /:id/:user</span>
  <span class="hljs-comment">// do something</span>
}
</code></pre>
<h4><a class="anchor" aria-hidden="true" id="action返回"></a><a href="#action返回" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>action返回</h4>
<p>默认情况下，actionXxx无需返回数据，如果actionXxx方法返回数据，且response未设置情况下，框架会将数据设置为该请求的响应数据。</p>
<pre><code class="hljs css languages- javascript"><span class="hljs-keyword">const</span> { Controller } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'salak'</span>)

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Post</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Controller</span> </span>{
  <span class="hljs-keyword">async</span> actionIndex () {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">id</span>: <span class="hljs-string">'xxxx'</span>,
      <span class="hljs-attr">title</span>: <span class="hljs-string">'Post'</span>
    }
  }
}

<span class="hljs-built_in">module</span>.exports = Post
</code></pre>
<p>如上，actionIndex 响应数据等同于 <code>this.ctx.body = { id: 'xxx', title: 'Post' }</code> 。</p>
<h4><a class="anchor" aria-hidden="true" id="覆盖路由规则"></a><a href="#覆盖路由规则" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>覆盖路由规则</h4>
<p>如果需要自定义路由规则覆盖默认规则，可以在controller或behavior中添加静态属性routes，如下：</p>
<pre><code class="hljs css languages- javascript"><span class="hljs-keyword">const</span> { Controller } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'salak'</span>)

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">User</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Controller</span> </span>{
  get <span class="hljs-keyword">static</span> routes () {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-string">'PATCH /:id'</span>: <span class="hljs-string">'update'</span>
    }
  }

  <span class="hljs-keyword">async</span> actionUpdate (id) {
    <span class="hljs-comment">// doUpdate</span>
  }
}

<span class="hljs-built_in">module</span>.exports = User
</code></pre>
<p>routes key规则：<code>METHOD path</code></p>
<p>Controller 继承于 <a href="./objects.html#base">Base</a>，除了Base提供的属性和方法，还有如下的属性和方法。</p>
<h3><a class="anchor" aria-hidden="true" id="属性"></a><a href="#属性" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>属性</h3>
<h4><a class="anchor" aria-hidden="true" id="ctx"></a><a href="#ctx" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>ctx</h4>
<p>当前请求的上下文 Koa.Context 对象的实例，可以通过它拿到框架封装以及应用扩展的便捷属性和方法。</p>
<h4><a class="anchor" aria-hidden="true" id="header"></a><a href="#header" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>header</h4>
<p>当前请求头部信息。</p>
<h4><a class="anchor" aria-hidden="true" id="query"></a><a href="#query" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>query</h4>
<p>获取请求query参数。</p>
<h4><a class="anchor" aria-hidden="true" id="status"></a><a href="#status" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>status</h4>
<p>获取和设置状态码。</p>
<h4><a class="anchor" aria-hidden="true" id="body"></a><a href="#body" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>body</h4>
<p>获取body，会拿到this.ctx.request.body。</p>
<p>设置body，会设置response返回内容。</p>
<h4><a class="anchor" aria-hidden="true" id="type"></a><a href="#type" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>type</h4>
<p>获取和设置<code>Content-Type</code>。</p>
<h3><a class="anchor" aria-hidden="true" id="方法"></a><a href="#方法" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>方法</h3>
<h4><a class="anchor" aria-hidden="true" id="middleware-name-module-options"></a><a href="#middleware-name-module-options" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>middleware (name, module, options)</h4>
<p>中间件调用，只允许出现在constructor中，用于在进入action之前，执行相应的的中间件</p>
<ul>
<li><code>name: string|Function</code>: 中间件名称，或控制器内中间件</li>
<li><code>module</code>: 可选，中间件所在的模块，默认为当前模块，也就是默认会加载当前模块的中间件</li>
<li><code>options</code>: 可选，配置，会往上回溯合并配置：options =&gt; module config</li>
</ul>
<p>@return {object} Middleware实例: 提供了only和except两个方法</p>
<ul>
<li><code>only (action)</code>: 只允许哪些函数可以执行中间件</li>
<li><code>except (action)</code>: 表示除了哪些action之外执行中间件</li>
</ul>
<p>action: type: string|Array 执行的action</p>
<pre><code class="hljs css languages- javascript"><span class="hljs-keyword">this</span>.middleware(<span class="hljs-string">'test'</span>) <span class="hljs-comment">// 表示所有方法都会执行test中间件</span>
<span class="hljs-keyword">this</span>.middleware(<span class="hljs-string">'auth'</span>).except(<span class="hljs-string">'logout'</span>) <span class="hljs-comment">// 表示actionLogout方法不执行auth中间件</span>
<span class="hljs-keyword">this</span>.middleware([<span class="hljs-string">'cors'</span>, <span class="hljs-string">'error'</span>]).only(<span class="hljs-string">'index'</span>) <span class="hljs-comment">// 表示只有actionIndex方法执行cors中间件和error中间件</span>
<span class="hljs-keyword">this</span>.middleware(<span class="hljs-keyword">async</span> (ctx, next) =&gt; {
  <span class="hljs-keyword">await</span> next()
})
</code></pre>
<h4><a class="anchor" aria-hidden="true" id="send-body-status-200"></a><a href="#send-body-status-200" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>send (body, status = 200)</h4>
<p>设置response。</p>
<h4><a class="anchor" aria-hidden="true" id="success-data-message-code-0"></a><a href="#success-data-message-code-0" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>success (data, message = '', code = 0)</h4>
<p>设置成功返回数据。</p>
<pre><code class="hljs css languages- javascript">{
  <span class="hljs-string">"code"</span>: <span class="hljs-number">0</span>,
  <span class="hljs-string">"msg"</span>: message,
  <span class="hljs-string">"data"</span>: data
}
</code></pre>
<h4><a class="anchor" aria-hidden="true" id="failure-code-message-data"></a><a href="#failure-code-message-data" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>failure (code, message = '', data)</h4>
<p>设置失败数据返回。</p>
<pre><code class="hljs css languages- javascript">{
  <span class="hljs-string">"code"</span>: <span class="hljs-number">-1</span>,
  <span class="hljs-string">"msg"</span>: <span class="hljs-string">""</span>,
  <span class="hljs-string">"data"</span>: <span class="hljs-literal">null</span>
}
</code></pre>
<p><strong>注：返回字段名可以通过配置output fields属性</strong></p>
<h2><a class="anchor" aria-hidden="true" id="restcontroller"></a><a href="#restcontroller" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>RestController</h2>
<p>除了Controller之外，框架还提供了RestController，扩展自Controller。内部自定义了Restful映射关系，一般用在Restful接口上。</p>
<p>映射关系表：</p>
<table>
<thead>
<tr><th>Action</th><th>Http</th></tr>
</thead>
<tbody>
<tr><td>index</td><td>GET /</td></tr>
<tr><td>create</td><td>POST /</td></tr>
<tr><td>show</td><td>GET /:id</td></tr>
<tr><td>replace</td><td>PUT /:id</td></tr>
<tr><td>update</td><td>PATCH /:id</td></tr>
<tr><td>destroy</td><td>DELETE /:id</td></tr>
</tbody>
</table>
<p>代码如下：</p>
<pre><code class="hljs css languages- javascript"><span class="hljs-keyword">const</span> { RestController } = <span class="hljs-built_in">require</span>(<span class="hljs-string">'salak'</span>)

<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Post</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">RestController</span> </span>{
  <span class="hljs-keyword">async</span> actionIndex () {

  }

  <span class="hljs-keyword">async</span> actionCreate () {

  }

  <span class="hljs-keyword">async</span> actionShow (id) {

  }

  <span class="hljs-keyword">async</span> actionReplace (id) {

  }

  <span class="hljs-keyword">async</span> actionUpdate (id) {

  }

  <span class="hljs-keyword">async</span> actionDestroy (id) {

  }
}

<span class="hljs-built_in">module</span>.exports = Post
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="获取http请求参数"></a><a href="#获取http请求参数" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>获取HTTP请求参数</h2>
<p>在Controller中，提供了比较多的便捷属性来获取。在Salak中，在behavior有定义的情况下，所有的query、body、params参数经过behavior格式校验后，会转换为对应的数据类型。</p>
<p>如：<code>{ id: Joi.number() }</code>，那么在Controller中获取<code>/?id=123</code>，<code>this.query.id</code>返回的是number类型。</p>
<h3><a class="anchor" aria-hidden="true" id="query-1"></a><a href="#query-1" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>query</h3>
<p>query常用于 GET 请求用来传递参数，如 <code>GET /post?id=123&amp;from=o2</code>，其中<code>id=123&amp;from=o2</code>为传递过来的参数，可以通过如下方式获取：</p>
<pre><code class="hljs css languages- javascript"><span class="hljs-keyword">const</span> { id, <span class="hljs-keyword">from</span> } = <span class="hljs-keyword">this</span>.query
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="body-1"></a><a href="#body-1" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>body</h3>
<p>我们通过URL来传递参数时，可能会存在2个问题：</p>
<ul>
<li>浏览器参数限制，参数过长会导致无法传递；</li>
<li>服务器一般会记录请求日志，一些敏感信息存到日志文件容易出现安全问题。</li>
</ul>
<p>在POST，PUT，DELETE请求中，我们常用body来传递参数。</p>
<p>框架内置了 <a href="./middleware.html#bodyparser">bodyParser</a> 中间件将请求body格式为object挂在到ctx.request.body。</p>
<p>可以通过如下方式来获取：</p>
<pre><code class="hljs css languages- javascript"><span class="hljs-comment">// POST /post HTTP/1.1</span>
<span class="hljs-comment">// Host: localhost:3000</span>
<span class="hljs-comment">// Content-Type: application/json; charset=UTF-8</span>
<span class="hljs-comment">//</span>
<span class="hljs-comment">// {"title": "post"}</span>

<span class="hljs-keyword">const</span> { title } = <span class="hljs-keyword">this</span>.body
</code></pre>
<h4><a class="anchor" aria-hidden="true" id="body长度限制"></a><a href="#body长度限制" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>body长度限制</h4>
<p>默认情况下，bodyParser限制了1m大小，当用户请求body超过了该解析大小，会抛出 <code>status: 413</code> 的异常。</p>
<p>我们可以调整 /common/config/default.js bodyParser 的配置项来更变body解析大小限制，如：</p>
<pre><code class="hljs css languages- javascript"><span class="hljs-built_in">module</span>.exports = {
  <span class="hljs-attr">bodyParser</span>: {
    <span class="hljs-attr">jsonLimit</span>: <span class="hljs-string">'1m'</span>,
    <span class="hljs-attr">formLimit</span>: <span class="hljs-string">'1m'</span>
  }
}
</code></pre>
<p>一般情况下，如果使用了nginx作为代理转发，也需要调整 <code>client_max_body_size</code> 的大小。</p>
<h3><a class="anchor" aria-hidden="true" id="params"></a><a href="#params" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>params</h3>
<p>框架会将actionXxx的参数自动注册到路由上，方法参数即为params。</p>
<p>如：/post/show/123</p>
<pre><code class="hljs css languages- javascript"><span class="hljs-keyword">async</span> actionShow (id) {

}
</code></pre>
<p>id 即为 ctx.params.id，为123</p>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/docs/docs/zh-cn/router.html">← 路由</a><a class="docs-next button" href="/docs/docs/zh-cn/behavior.html">Behavior →</a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#controller编写">Controller编写</a><ul class="toc-headings"><li><a href="#action定义">action定义</a></li><li><a href="#属性">属性</a></li><li><a href="#方法">方法</a></li></ul></li><li><a href="#restcontroller">RestController</a></li><li><a href="#获取http请求参数">获取HTTP请求参数</a><ul class="toc-headings"><li><a href="#query-1">query</a></li><li><a href="#body-1">body</a></li><li><a href="#params">params</a></li></ul></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/docs/" class="nav-home"><img src="/docs/img/salak.png" alt="Salak" width="66" height="58"/></a><div><h5>Docs</h5><a href="/docs/docs/zh-cn/introduction.html">Getting Started</a><a href="/docs/docs/zh-cn/structure.html">Guides</a></div><div><h5>About</h5><a href="https://aotu.io" target="_blank">aotu.io</a></div></section><section class="copyright">Copyright © 2019 凹凸实验室</section></footer></div></body></html>